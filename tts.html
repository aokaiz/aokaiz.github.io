<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>时温等效（WLF） — 构造主曲线和性能预测（高分子）</title>
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#ffffff;color:#111;font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    .container{max-width:1100px;margin:18px auto;padding:16px}
    h1{font-size:20px;margin:0 0 8px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .card{background:#fbfbfb;border:1px solid #eee;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    input,button,select{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ccc}
    label{display:block;font-size:13px;margin-bottom:6px}
    #plots{display:grid;grid-template-columns:1fr;gap:12px}
    .row{display:flex;gap:12px}
    .small{width:220px}
    .fullwidth{width:100%}
    .note{font-size:13px;color:#444;margin-top:8px}
    .footer{font-size:12px;color:#666;margin-top:10px}
    a.sample{display:inline-block;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>时温等效（WLF） — 构造主曲线和性能预测（高分子）</h1>
    <div class="controls">
      <div class="card small">
        <label>上传 CSV（支持两种格式）</label>
        <input type="file" id="fileinput" accept=".csv">
        <div class="note">CSV 格式说明：<br>
          <b>宽表（推荐）</b>：第一列名为 <code>time</code>（单位 s），其余列为不同温度数据，列头包含温度信息，例如 <code>T=25</code> 或 <code>25</code>。<br>
          <b>长表</b>：含三列 <code>time,temp,stress</code>（任意顺序亦可）。
        </div>
        <button id="loadSample">下载示例 CSV</button>
      </div>

      <div class="card small">
        <label>WLF 参数</label>
        <div style="display:flex;gap:8px;flex-direction:column">
          <input id="C1" placeholder="C1 (默认 17.44)" value="17.44">
          <input id="C2" placeholder="C2 (默认 51.6)" value="51.6">
          <input id="Tref" placeholder="参考温度 T_ref (°C, 默认 25)" value="25">
        </div>
      </div>

      <div class="card small">
        <label>目标温度（预测）</label>
        <input id="Ttarget" value="40">
        <div class="note">在输入目标温度后，点击“生成预测曲线”</div>
      </div>

      <div class="card fullwidth" style="flex:1;min-width:260px">
        <label>操作</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="build">构造 Master Curve</button>
          <button id="predict">生成预测曲线（目标温度）</button>
          <button id="clear">清除</button>
        </div>
        <div class="note">说明：先上传或加载示例数据，调整 WLF 参数和参考温度，再点击“构造 Master Curve”。</div>
      </div>
    </div>

    <div id="plots">
      <div id="rawPlot" style="height:360px" class="card"></div>
      <div id="masterPlot" style="height:360px" class="card"></div>
      <div id="predictPlot" style="height:360px" class="card"></div>
    </div>

    <div class="footer">提示：时间轴与应力将以对数坐标显示；你可以在图例中单击隐藏/显示曲线。</div>
  </div>

<script>
// ---------- 工具函数 ----------
function downloadText(filename, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
  a.download = filename;
  a.click();
}

function parseCSVText(text){
  // 返回 array of objects: [{time:..., temp:..., stress:...}] 或 wide 表解析为 {time:[], temps:{T:stressArray}}
  const rows = text.trim().split(/\r?\n/).map(r=>r.split(/,|;|\t/).map(c=>c.trim()));
  if(rows.length<2) return null;
  const header = rows[0].map(h=>h.replace(/"/g,'').trim());
  const numeric = (s)=>{const v=parseFloat(s); return isNaN(v)?null:v};
  // Detect wide format: first header is time and other headers are temperatures
  const h0 = header[0].toLowerCase();
  if(h0==='time' || h0==='t' || h0==='seconds' || h0==='s'){
    // wide
    const time = rows.slice(1).map(r=>numeric(r[0])).filter(x=>x!==null);
    const temps = {};
    for(let j=1;j<header.length;j++){
      const h = header[j];
      // extract number from header
      const m = h.match(/-?\d+\.?\d*/);
      const T = m?parseFloat(m[0]):h;
      temps[T] = rows.slice(1).map(r=>numeric(r[j])).map(v=>v===null?NaN:v);
    }
    return {format:'wide', time, temps};
  }
  // long format detection: columns include time,temp,stress
  const low = header.map(h=>h.toLowerCase());
  if(low.includes('time') && (low.includes('temp')||low.includes('temperature')) && (low.includes('stress')||low.includes('g')||low.includes('modulus'))){
    const ti = low.indexOf('time');
    const pi = low.indexOf('temp')>=0?low.indexOf('temp'):low.indexOf('temperature');
    const si = low.indexOf('stress')>=0?low.indexOf('stress'):(low.indexOf('g')>=0?low.indexOf('g'):low.indexOf('modulus'));
    const data = rows.slice(1).map(r=>({time:numeric(r[ti]), temp:numeric(r[pi]), stress:numeric(r[si])})).filter(d=>d.time!=null&&d.temp!=null&&d.stress!=null);
    return {format:'long', data};
  }
  // fallback: treat every column except first as a temperature column
  const time = rows.slice(1).map(r=>numeric(r[0])).filter(x=>x!==null);
  const temps = {};
  for(let j=1;j<header.length;j++){
    temps[header[j]] = rows.slice(1).map(r=>numeric(r[j])).map(v=>v===null?NaN:v);
  }
  return {format:'wide', time, temps};
}

function wlf_log10aT(T, Tref, C1, C2){
  const d = T - Tref;
  return -C1 * d / (C2 + d);
}

function uniqueSorted(arr){return Array.from(new Set(arr)).sort((a,b)=>a-b);}

function interpolateLogLog(points, t){
  // points: [{t:..., y:...}] unsorted. interpolate in log-log: log10(y) vs log10(t)
  const pts = points.filter(p=>p.t>0 && p.y>0).slice();
  if(pts.length===0) return NaN;
  pts.sort((a,b)=>a.t-b.t);
  const ts = pts.map(p=>p.t);
  const ys = pts.map(p=>Math.log10(p.y));
  const logt = Math.log10(t);
  if(t<=ts[0]){
    // linear extrapolate using first two
    if(ts.length===1) return Math.pow(10, ys[0]);
    const x0=Math.log10(ts[0]), x1=Math.log10(ts[1]);
    const y0=ys[0], y1=ys[1];
    const y = y0 + (logt-x0)*(y1-y0)/(x1-x0);
    return Math.pow(10,y);
  }
  if(t>=ts[ts.length-1]){
    if(ts.length===1) return Math.pow(10, ys[0]);
    const n=ts.length; const x0=Math.log10(ts[n-2]), x1=Math.log10(ts[n-1]);
    const y0=ys[n-2], y1=ys[n-1];
    const y = y0 + (logt-x0)*(y1-y0)/(x1-x0);
    return Math.pow(10,y);
  }
  // find interval
  let i=0; while(!(t>=ts[i] && t<=ts[i+1])) i++;
  const x0=Math.log10(ts[i]), x1=Math.log10(ts[i+1]);
  const y0=ys[i], y1=ys[i+1];
  const y = y0 + (logt-x0)*(y1-y0)/(x1-x0);
  return Math.pow(10,y);
}

// ---------- 主逻辑 ----------
let current = {raw:null, master:null};

function plotRawWide(time, temps){
  const traces = [];
  const colors = null; // let Plotly pick
  for(const k of Object.keys(temps)){
    const y = temps[k];
    const clean = time.map((t,i)=>({t:t, y:y[i]})).filter(p=>!isNaN(p.y)&&p.t>0);
    traces.push({x:clean.map(p=>p.t), y:clean.map(p=>p.y), mode:'lines+markers', name:`T=${k} °C`});
  }
  const layout = {title:'原始数据（对数坐标）', xaxis:{type:'log', title:'time (s)'}, yaxis:{type:'log', title:'stress (Pa)'}};
  Plotly.newPlot('rawPlot', traces, layout, {responsive:true});
}

function plotMaster(masterPoints){
  const x = masterPoints.map(p=>p.t);
  const y = masterPoints.map(p=>p.y);
  const trace = {x,y,mode:'lines',name:'Master Curve (at T_ref)',line:{width:2}};
  const layout = {title:'Master Curve（在参考温度）', xaxis:{type:'log', title:'shifted time (s)'}, yaxis:{type:'log', title:'stress (Pa)'}};
  Plotly.newPlot('masterPlot',[trace],layout,{responsive:true});
}

function plotPrediction(t_pred, y_pred, Ttarget){
  const trace = {x:t_pred, y:y_pred, mode:'lines', name:`预测 @ ${Ttarget} °C`};
  const layout = {title:`在 ${Ttarget} °C 下的数据预测`, xaxis:{type:'log', title:'time (s)'}, yaxis:{type:'log', title:'stress (Pa)'}};
  Plotly.newPlot('predictPlot',[trace],layout,{responsive:true});
}

function buildMasterFromWide(time, temps, Tref, C1, C2){
  // For each temperature column, compute a_T and shift time by a_T (t_shift = t * a_T)
  const combined = [];
  for(const k of Object.keys(temps)){
    const T = parseFloat(k);
    const log10a = wlf_log10aT(T, Tref, C1, C2);
    const a = Math.pow(10, log10a);
    const arr = temps[k];
    for(let i=0;i<Math.min(arr.length,time.length);i++){
      const t = time[i]; const y = arr[i];
      if(!isFinite(t) || !isFinite(y) || t<=0 || y<=0) continue;
      combined.push({t: t * a, y: y});
    }
  }
  if(combined.length===0) return null;
  combined.sort((a,b)=>a.t-b.t);
  // construct grid (log spaced)
  const tmin = combined[0].t; const tmax = combined[combined.length-1].t;
  const n = 300;
  const logtmin = Math.log10(tmin); const logtmax = Math.log10(tmax);
  const grid = Array.from({length:n},(_,i)=>Math.pow(10, logtmin + (logtmax-logtmin)*i/(n-1)));
  const master = grid.map(gt=>({t:gt, y:interpolateLogLog(combined, gt)}));
  return {combined, master};
}

function buildMasterFromLong(data, Tref, C1, C2){
  // group by temperatures
  const groups = {};
  for(const d of data){
    if(!isFinite(d.time) || !isFinite(d.temp) || !isFinite(d.stress) || d.time<=0 || d.stress<=0) continue;
    if(!(d.temp in groups)) groups[d.temp]=[];
    groups[d.temp].push({t:d.time,y:d.stress});
  }
  const combined = [];
  for(const Tstr of Object.keys(groups)){
    const T=parseFloat(Tstr);
    const log10a = wlf_log10aT(T, Tref, C1, C2);
    const a = Math.pow(10, log10a);
    for(const p of groups[Tstr]) combined.push({t:p.t * a, y:p.y});
  }
  if(combined.length===0) return null;
  combined.sort((a,b)=>a.t-b.t);
  const tmin = combined[0].t; const tmax = combined[combined.length-1].t;
  const n = 300;
  const logtmin = Math.log10(tmin); const logtmax = Math.log10(tmax);
  const grid = Array.from({length:n},(_,i)=>Math.pow(10, logtmin + (logtmax-logtmin)*i/(n-1)));
  const master = grid.map(gt=>({t:gt, y:interpolateLogLog(combined, gt)}));
  return {combined, master};
}

// ---------- UI 绑定 ----------
document.getElementById('loadSample').addEventListener('click', ()=>{
  const sample = `time,-80,-50,-10,25,50
0.01,727622385.250796,7425.792301,0.0,8493811254.172606,9212936477.761562
0.010718913192051274,733564762.331789,7617.777929,0.0,8437609911.319598,9213219210.023323
0.011489510001873092,739526438.403592,7815.001706,0.0,8378522095.820815,9213505764.235197
0.012315506032928254,745543113.550449,8016.486579,0.0,8316463903.587633,9213796150.632519
0.01320088400831418,751618642.339815,8222.732731,0.0,8251355158.836667,9214090675.843912
0.01414991297434576,757700420.163004,8433.544325,0.0,8183120203.012628,9214389493.404081
0.015167168884709226,763834763.768164,8650.824372,0.0,8111688727.640589,9214692672.891573
0.01625755666443794,770035680.180363,8870.896849,0.0,8036996646.182018,9215000550.675047
0.0174263338600965,776205117.069748,9099.924325,0.0,7958986998.632418,9215313191.450527
0.01867913599020783,782434291.667801,9332.405293,0.0,7877610881.184238,9215630738.979897
0.020022003718155844,788709992.533699,9571.329999,0.0,7792828391.820634,9215953450.69056
0.021461411978584036,795039520.828061,9814.647242,0.0,7704609581.23211,9216281497.587463
0.02300430119772918,801349453.691741,10066.448632,0.0,7612935397.003683,9216615055.65004
0.024658110758226024,807752035.163018,10321.808523,0.0,7517798607.642845,9216954209.478315
0.026430814869741054,814170013.88828,10584.204031,0.0,7419204691.775215,9217299256.179617
0.02833096101839324,820599342.302429,10853.270017,0.0,7317172676.75591,9217650280.423658
0.030367711180354577,827119399.066877,11130.935784,0.0,7211735910.120103,9218007475.626003
0.032550885998350584,833672953.859714,11411.695077,0.0,7102942746.756903,9218371047.599434
0.034891012134067735,840219391.027361,11700.563748,0.0,6990857134.509859,9218741152.779232
0.03739937302478798,846843268.208759,11995.480226,0.0,6875559081.135728,9219117955.053078
0.04008806328898464,853481880.467954,12297.614131,0.0,6757144986.225004,9219501650.477156
0.04297004704320839,860115870.298974,12609.129922,0.0,6635727822.850603,9219892400.555037
0.046059220411451066,866892794.298635,12926.947103,0.0,6511437155.369287,9220290384.134365
0.049370478528390035,873600331.011429,13250.912572,0.0,6384418981.965702,9220695764.044449
0.05291978735958442,880417764.731705,13585.144745,0.0,6254835393.173593,9221108750.124323
0.05672426068491977,887233846.755044,13927.807366,0.0,6122864040.702279,9221529468.22474
0.06080224261649421,894122331.978049,14274.097044,0.0,5988697414.368788,9221958139.410591
0.06517339604882423,901008898.587215,14633.880257,0.0,5852541928.709332,9222394903.227907
0.0698587974678525,907960468.564978,14995.617546,0.0,5714616824.815591,9222839951.805101
0.07488103857590023,914913434.717417,15374.127071,0.0,5575152896.994399,9223293455.696278
0.08026433522257173,921980380.941337,15758.591402,0.0,5434391057.852278,9223755597.2561
0.086034644166845,928995827.550811,16146.144975,0.0,5292580759.227193,9224226545.300097
0.09221978823334327,936093433.155173,16549.915334,0.0,5149978289.893635,9224706474.88477
0.09884959046625585,943274263.53073,16960.80305,0.0,5006844974.019967,9225195565.45619
0.10595601792776159,950435040.800923,17380.670578,0.0,4863445296.853337,9225693985.705742
0.11357333583431051,957624943.731089,17814.374126,0.0,4720044985.943391,9226201922.628323
0.12173827277396615,964890425.184957,18252.16525,0.0,4576909077.323578,9226719540.101763
0.13049019780144022,972142715.494326,18705.315029,0.0,4434299996.406891,9227247019.693567
0.1398713102647238,979492532.051549,19166.01123,0.0,4292475682.905842,9227784538.096498
0.14992684327860456,986858908.536972,19641.504176,0.0,4151687787.876508,9228332267.9021
0.16070528182616384,994258851.299063,20122.076257,0.0,4012179969.061631,9228890383.631388
0.17225859653987866,1001692285.825919,20619.114938,0.0,3874186308.146784,9229459067.303883
0.18464249428955434,1009203456.385577,21125.090784,0.0,3737929870.443188,9230038489.112457
0.19791668678535562,1016726295.418135,21644.243305,0.0,3603621423.993515,9230628829.99986
0.21214517849106299,1024269223.472172,22174.595834,0.0,3471458331.286661,9231230262.641544
0.22739657523579274,1031863579.508307,22716.347362,0.0,3341623622.80338,9231842964.552967
0.24374441501222205,1039500547.216726,23274.60527,0.0,3214285257.623964,9232467112.75695
0.26126752255633273,1047189438.108221,23841.974773,0.0,3089595572.441696,9233102882.6255
0.28005038941836313,1054893504.481619,24421.459012,0.0,2967690916.651414,9233750451.710154
0.3001835813575589,1062635581.055103,25018.104057,0.0,2848691467.816187,9234409996.186651
0.32176417502507354,1070425075.996237,25624.373696,0.0,2732701218.837116,9235081692.974384
0.3448962260405758,1078257464.020264,26246.718428,0.0,2619808125.614142,9235765718.887915
0.36969127071950264,1086123311.649164,26883.705903,0.0,2510084401.924022,9236462250.924519
0.3962688638701478,1094060955.043064,27537.603817,0.0,2403586946.673062,9237171466.085238
0.42475715525368984,1102008209.17507,28199.479279,0.0,2300357887.596483,9237893541.647772
0.4552935074866947,1109983942.560457,28883.351335,0.0,2200425224.859845,9238628654.863873
0.48802515836544313,1118017399.946904,29576.533106,0.0,2103803557.828807,9239376983.132122
0.5231099308056261,1126069434.347179,30293.800411,0.0,2010494878.475266,9240138703.965855
0.5607169938205459,1134204365.930261,31020.2871,0.0,1920489415.421619,9240913994.71423
0.6010276782070382,1142362945.740147,31766.986114,0.0,1833766513.44156,9241703031.495363
0.644236350872137,1150554946.49652,32532.230653,0.0,1750295534.27294,9242505988.573711
0.6905513520162326,1158754801.234862,33310.642371,0.0,1670036765.80418,9243323038.013502
0.7401959996915641,1167028471.345804,34105.881962,0.0,1592942328.014774,9244154349.308273
0.7934096665797491,1175356054.631398,34920.720117,0.0,1518957065.434494,9245000088.984003
0.8504489341802677,1183701471.503441,35758.794837,0.0,1448019417.293262,9245860420.174685
0.9115888299750818,1192085201.658271,36605.405913,0.0,1380062257.924524,9246735502.166946
0.9771241535346498,1200528310.746896,37479.961258,0.0,1315013701.331283,9247625489.913427
1.0473708979594496,1208978121.868473,38377.433492,0.0,1252797865.098909,9248530533.512392
1.1226677735108137,1217476712.275126,39282.591817,0.0,1193335590.02565,9249450777.651075
1.2033778407775892,1226045813.204734,40218.282741,0.0,1136545112.926111,9250386361.01081
1.289890261253308,1234604736.668264,41174.091323,0.0,1082342691.037713,9251337415.63189
1.382622173764655,1243256169.86763,42140.768719,0.0,1030643177.321311,9252304066.235077
1.4820207057988586,1251929739.116362,43140.750426,0.0,981360546.693925,9253286429.496752
1.5885651294280527,1260613990.834636,44159.030627,0.0,934408373.868208,9254284613.27697
1.7027691722258995,1269330608.793943,45203.728245,0.0,889700264.003141,9255298715.79377
1.8251834943190424,1278118725.03449,46273.140923,0.0,847150237.801917,9256328824.744081
1.9563983435170629,1286973337.304393,47355.373105,0.0,806673073.032761,9257375016.365639
2.0970464013232326,1295860836.651003,48472.282348,0.0,768184604.706092,9258437354.437317
2.247805833548725,1304763867.489858,49607.690777,0.0,731601986.325283,9259515889.213413
2.4094035602395243,1313699217.306768,50767.91112,0.0,696843914.748052,9260610656.288057
2.5826187606826747,1322701567.708606,51955.266595,0.0,663830821.259151,9261721675.386194
2.7682866303920637,1331707120.637962,53169.457783,0.0,632485031.471729,9262848949.07454
2.9673024081888695,1340791652.942014,54416.80412,0.0,602730896.651774,9263992461.390205
3.180625692794119,1349896657.098091,55682.651796,0.0,574494899.004927,9265152176.380255
3.4092850697468107,1359045584.999163,56979.94765,0.0,547705733.383792,9266328036.546362
3.6543830709572545,1368286565.878853,58303.370854,0.0,522294367.772991,9267519961.190943
3.917101490809257,1377457285.043378,59660.676199,0.0,498194084.793439,9268727844.655684
4.198707084443909,1386726010.59721,61042.072795,0.0,475340506.340662,9269951554.448536
4.500557675700498,1396038710.537866,62463.135257,0.0,453671603.339131,9271190929.250595
4.8241087041653685,1405389261.710709,63893.704497,0.0,433127692.457856,9272445776.796694
5.170920242896755,1414802442.09761,65374.262015,0.0,413651421.49497,9273715871.621038
5.542664520663101,1424216120.623418,66883.252244,0.0,395187745.00273,9275000952.660051
5.941133984965034,1433717621.361566,68430.679821,0.0,377683891.590993,9276300720.704153
6.368249944718586,1443200110.15003,69993.002912,0.0,361089324.218285,9277614835.688457
6.826071834272385,1452742125.225022,71602.314855,0.0,345355694.655478,9278942913.813164
7.316807143427192,1462344018.111435,73251.202464,0.0,330436793.189666,9280284524.483126
7.8428220613376824,1471993212.710055,74927.530383,0.0,316288494.524088,9281639187.05577
8.406652885618325,1481634497.250096,76642.220475,0.0,302868700.725615,9283006367.385288
9.01101825166502,1491368404.418823,78401.659682,0.0,290137281.973421,9284385474.15167
9.658832241158699,1501123407.474332,80188.810171,0.0,278056015.771646,9285775854.960579
10.353218432956615,1510909039.09676,82019.580085,0.0,266588525.204719,9287176792.201294
11.097524964120721,1520715049.663465,83887.726665,0.0,255700216.736438,9288587498.647078
11.895340673703195,1530621674.448334,85787.873619,0.0,245358217.982761,9290007112.78417
12.750512407130127,1540528559.558622,87740.308629,0.0,235531315.823091,9291434693.850521
13.667163564620058,1550485947.561582,89727.720695,0.0,226189895.155482,9292869216.570522
14.649713983072848,1560459722.634258,91758.537809,0.0,217305878.547381,9294309565.564137
15.702901247293775,1570494207.101467,93843.561165,0.0,208852666.984793,9295754529.413397
16.831803533309564,1580558509.86561,95964.16081,0.0,200805081.878969,9297202794.36575
18.04186409392072,1590711759.673198,98124.060754,0.0,193139308.450542,9298652937.651192
19.3389175045523,1600814224.714856,100343.150355,0.0,185832840.576204,9300103420.392984
20.729217795953698,1611030376.456912,102601.609794,0.0,178864427.152276,9301552580.086126
22.219468609395236,1621269003.503554,104894.315466,0.0,172214020.002643,9302998622.61955
23.81685551976158,1631561952.031388,107257.093823,0.0,165862723.335422,9304439613.81528
25.529080682395165,1641887798.035144,109667.314688,0.0,159792744.732953,9305873470.456038
27.36439997074669,1652188290.190743,112102.15275,0.0,153987347.643371,9307297950.773485
29.331662783900423,1662619119.371854,114619.235473,0.0,148430805.328803,9308710644.364103
31.440354715915003,1673027627.732152,117176.366481,0.0,143108356.214894,9310108961.501802
33.70064329271928,1683501296.564277,119784.23351,0.0,138006160.579037,9311490121.813482
36.123426997094306,1694021934.039178,122458.745792,0.0,133111258.509845,9312851142.27957
38.72038781812553,1704578372.560034,125184.176996,0.0,128411529.068174,9314188824.524767
41.504047578504725,1715170463.174787,127956.777295,0.0,123895650.580028,9315499741.35798
44.48782831127585,1725790474.72035,130802.274343,0.0,119553061.993846,9316780222.520897
47.6861169771447,1736411420.922188,133694.607814,0.0,115373925.238734,9318026339.602
51.11433483440165,1747162952.466119,136646.096207,0.0,111349088.525927,9319233890.07192
54.78901179593939,1757907709.788047,139697.095924,0.0,107470050.542938,9320398380.392908
58.727866131894764,1768683590.279338,142766.048417,0.0,103728925.498153,9321515008.15304
62.949889902218885,1779545064.89573,145902.421563,0.0,100118408.982785,9322578643.17712
67.47544053110693,1790382812.267774,149107.696501,0.0,96631744.626874,9323583807.558765
72.32633896483534,1801270741.629184,152386.0639,0.0,93262691.536012,9324524654.562357
77.52597488629456,1812212945.764689,155744.719207,0.0,90005492.505482,9325394946.336828
83.09941949353386,1823173577.58694,159146.644172,0.0,86854843.018131,9326188030.385517
89.0735463861044,1834260918.79148,162645.733637,0.0,83805861.041379,9326896814.731094
95.47716114208056,1845306274.933489,166183.799484,0.0,80854057.646955,9327513741.71709
102.34114021054526,1856426295.914795,169801.812537,0.0,77995308.484018,9328030760.382475
109.6985797892384,1867510802.132308,173513.834114,0.0,75225826.142187,9328439297.348255
117.58495540521557,1878723374.420596,177272.744241,0.0,72542133.44532,9328730226.151335
126.03829296797275,1889936863.761554,181141.722693,0.0,69941037.71975,9328893834.963236
135.0993521198025,1901183883.758364,185078.884195,0.0,67419606.08188,9328919792.629263
144.8118227674533,1912447439.24799,189101.620906,0.0,64975141.789656,9328797112.965578
155.2225357427048,1923790399.028309,193177.853651,0.0,62605161.700474,9328514117.252312
166.38168860761272,1935179387.71497,197369.688888,0.0,60307374.874608,9328058394.8625
178.3430876931909,1946567406.913911,201617.062408,0.0,58079662.358435,9327416761.969593
191.16440753856998,1958005243.058039,205973.930195,0.0,55920058.175739,9326575218.279608
204.9074689815846,1969549211.089466,210424.948232,0.0,53826731.548319,9325518901.737892
219.6385372416547,1981035080.371595,214960.821908,0.0,51797970.359365,9324232041.167751
235.42864143224153,1992579180.990953,219532.755533,0.0,49832165.864685,9322697906.80218
252.3539170434766,2004186151.604851,224261.015389,0.0,47927798.648187,9320898758.682705
270.4959730463131,2015843027.401721,229095.136271,0.0,46083425.809238,9318815792.90451
289.94228538828753,2027509822.696345,233967.688149,0.0,44297669.360887,9316429085.703861
310.7866187782014,2039199360.567248,238977.455997,0.0,42569205.809624,9313717535.39431
333.129478793467,2050951790.341754,244090.206051,0.0,40896756.879554,9310658802.17687
357.07859649004627,2062726656.140722,249268.546024,0.0,39279081.336747,9307229245.868982
382.74944785163075,2074560012.322516,254592.521336,0.0,37714967.86322,9303403861.617039
410.265810582719,2086378784.696457,259938.863517,0.0,36203228.924571,9299156213.685629
439.7603609302721,2098310965.28517,265490.739653,0.0,34742695.570859,9294458367.44419
471.3753134116719,2110278948.825556,271127.851938,0.0,33332213.106855,9289280819.706297
505.263106533568,2122245288.037178,276845.745653,0.0,31970637.565338,9283592427.612366
541.5871378079464,2134190436.96516,282743.824049,0.0,30656832.915655,9277360336.291868
580.5225516094896,2146292366.297838,288681.332445,0.0,29389668.939253,9270549905.587208
622.2570836730231,2158330209.207396,294795.309285,0.0,28168019.704223,9263124636.173801
666.9919663030115,2170468931.309998,301038.773931,0.0,26990762.572095,9255046095.473248
714.9428986597576,2182580065.754894,307306.478748,0.0,25856777.67197,9246273843.81863
766.3410868007447,2194778057.982037,313759.793171,0.0,24764947.779612,9236765361.40667
821.4343584919421,2207010297.155906,320354.252362,0.0,23714158.542096,9226475976.649363
880.4883581643464,2219300963.909282,327070.073169,0.0,22703298.992098,9215358796.625698
943.7878277775371,2231562067.79812,333862.160678,0.0,21731262.299627,9203364640.428917
1011.6379797662071,2243950040.873704,340837.206419,0.0,20796946.713025,9190441976.308434
1084.3659686896085,2256282914.15461,347945.749593,0.0,19899256.645147,9176536863.614523
1162.322468679852,2268718442.72986,355221.269802,0.0,19037103.864854,9161592900.674595
1245.883364295008,2281112306.302784,362629.808791,0.0,18209408.7581,9145551179.854378
1335.4515629298974,2293634315.509218,370140.838445,0.0,17415101.626987,9128350251.1912
1431.4589375234784,2306118716.056882,377760.984918,0.0,16653123.999152,9109926096.125784
1534.36840893001,2318681253.244962,385612.517327,0.0,15922429.923622,9090212113.002308
1644.6761779946626,2331286627.920226,393613.409348,0.0,15221987.232872,9069139116.155962
1762.914118095948,2343867884.267837,401752.076262,0.0,14550778.754186,9046635350.55585
1889.6523396912075,2356542911.603804,409986.994692,0.0,13907803.456528,9022626524.119629
2025.5019392306665,2369234455.211918,418449.512665,0.0,13292077.521957,8997035859.9638
2171.1179456945006,2381915892.574256,427041.690717,0.0,12702635.333242,8969784170.988392
2327.2024789604075,2394696759.032059,435863.890587,0.0,12138530.371616,8940789959.325495
2494.5081352303164,2407488051.20118,444751.135366,0.0,11598836.020684,8909969543.289797
2673.8416158399436,2420278575.696871,453875.400881,0.0,11082646.274294,8877237214.55805
2866.06761694825,2433131710.8485,463154.308042,0.0,10589076.347771,8842505428.367699
3072.112998861753,2446074589.285104,472622.910696,0.0,10117263.193214,8805685029.547447
3292.971255097148,2458994519.085712,482285.086927,0.0,9666365.920742,8766685517.17735
3529.70730273065,2471901268.044093,492058.344995,0.0,9235566.12845,8725415350.606064
3783.462617131925,2484903044.878978,502056.111747,0.0,8824068.144656,8681782299.421902
4055.460735840828,2497962238.174811,512266.014736,0.0,8431099.186566,8635693839.775326
4347.013158125017,2511007352.14244,522692.730376,0.0,8055909.439987,8587057599.168697
4659.525668664677,2524131677.178146,533256.724027,0.0,7697772.065012,8535781851.45916
4994.50511585514,2537213166.747648,544053.338333,0.0,7355983.132841,8481776063.353356
5353.5666774107185,2550396054.570647,554990.543841,0.0,7029861.499011,8424951493.09226
5738.441648302392,2563534849.597681,566286.878981,0.0,6718748.618361,8365221841.340804
6150.985788580504,2576775281.414085,577691.346127,0.0,6422008.307007,8302503953.481827
6593.188271333541,2590072723.704574,589263.374174,0.0,6139026.456528,8236718571.589047
7067.181273927491,2603330167.940192,601141.125946,0.0,5869210.705429,8167791133.302965
7575.250258771905,2616666963.145592,613118.259902,0.0,5611990.072749,8095652613.668129
8119.84499318401,2629991227.80856,625498.829691,0.0,5366814.558498,8020240404.724734
8703.591361485165,2643394949.950151,637972.473837,0.0,5133154.715377,7941499226.286683
9329.304026284675,2656814476.220224,650683.435457,0.0,4910501.195962,7859382059.915868
10000.0,2670231764.208453,663659.308856,0.0,4698364.279325,7773851096.635181
`;
  downloadText('sample_relaxation.csv', sample);
});

document.getElementById('fileinput').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = parseCSVText(e.target.result);
      current.raw = parsed;
      if(parsed.format==='wide') plotRawWide(parsed.time, parsed.temps);
      else plotRawWide( uniqueSorted(parsed.data.map(d=>d.time)), (function(){
        const temps={};
        for(const d of parsed.data){ if(!(d.temp in temps)) temps[d.temp]=[]; temps[d.temp].push(d.stress);} return temps; })());
      alert('文件已加载。请设置 WLF 参数并点击“构造 Master Curve”。');
    }catch(err){alert('解析 CSV 时出错: '+err.message)}
  }
  reader.readAsText(f);
});

document.getElementById('build').addEventListener('click', ()=>{
  try{
    const C1 = parseFloat(document.getElementById('C1').value);
    const C2 = parseFloat(document.getElementById('C2').value);
    const Tref = parseFloat(document.getElementById('Tref').value);
    if(!current.raw){alert('请先上传 CSV 或下载示例并加载'); return;}
    let result = null;
    if(current.raw.format==='wide'){
      result = buildMasterFromWide(current.raw.time, current.raw.temps, Tref, C1, C2);
    } else {
      result = buildMasterFromLong(current.raw.data, Tref, C1, C2);
    }
    if(!result){alert('无法构造 Master Curve（数据可能为空或格式不对）');return;}
    current.master = {combined:result.combined, master:result.master, C1,C2,Tref};
    plotMaster(result.master);
    // also show raw plot with shifted traces for visual check
    const traces = [];
    // original raw plotted earlier; add shifted traces overlay
    const colors = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b'];
    let idx=0;
    if(current.raw.format==='wide'){
      for(const k of Object.keys(current.raw.temps)){
        const arr = current.raw.temps[k];
        const log10a = wlf_log10aT(parseFloat(k), Tref, C1, C2);
        const a = Math.pow(10, log10a);
        const pts = current.raw.time.map((t,i)=>({t:t*a, y:arr[i]})).filter(p=>p.t>0 && isFinite(p.y) && p.y>0);
        traces.push({x:pts.map(p=>p.t), y:pts.map(p=>p.y), mode:'lines', name:`shifted T=${k}`, line:{dash:'dash'}});
        idx=(idx+1)%colors.length;
      }
    } else {
      // group long
      const groups = {};
      for(const d of current.raw.data){ if(!isFinite(d.time)||!isFinite(d.stress)) continue; if(!(d.temp in groups)) groups[d.temp]=[]; groups[d.temp].push(d);} 
      for(const k of Object.keys(groups)){
        const log10a = wlf_log10aT(parseFloat(k), Tref, C1, C2);
        const a = Math.pow(10, log10a);
        const pts = groups[k].map(p=>({t:p.time*a, y:p.stress})).filter(p=>p.t>0 && p.y>0);
        traces.push({x:pts.map(p=>p.t), y:pts.map(p=>p.y), mode:'lines', name:`shifted T=${k}`, line:{dash:'dash'}});
      }
    }
    // overlay on rawPlot
    Plotly.addTraces('rawPlot', traces);
    alert('已构造 Master Curve 并在“Master Curve”图显示；原始图中添加了水平位移后的曲线（虚线）以便检查位移效果。');
  }catch(err){alert(err.message)}
});

document.getElementById('predict').addEventListener('click', ()=>{
  try{
    if(!current.master){alert('请先构造 Master Curve');return;}
    const Ttarget = parseFloat(document.getElementById('Ttarget').value);
    const log10a_target = wlf_log10aT(Ttarget, current.master.Tref, current.master.C1, current.master.C2);
    const a_target = Math.pow(10, log10a_target);
    // To predict at target T, shift master curve back: t_at_T = t_master / a_T
    const t_pred = current.master.master.map(p=>p.t / a_target);
    const y_pred = current.master.master.map(p=>p.y);
    plotPrediction(t_pred, y_pred, Ttarget);
    alert('预测已生成并显示在下方图表。');
  }catch(err){alert(err.message)}
});

document.getElementById('clear').addEventListener('click', ()=>{
  current = {raw:null, master:null};
  Plotly.purge('rawPlot'); Plotly.purge('masterPlot'); Plotly.purge('predictPlot');
});

</script>
</body>
</html>
